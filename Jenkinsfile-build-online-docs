pipeline {
    agent {
        label 'agent-one-time-use'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                checkout changelog: false, poll: false, scm: scmGit(branches: [[name: 'refs/heads/master']], extensions: [cloneOption(depth: 1, noTags: true, reference: '', shallow: true), [$class: 'RelativeTargetDirectory', relativeTargetDir: 'sources']], userRemoteConfigs: [[url: 'https://tuleap.net/plugins/git/tuleap/tuleap/stable.git']])
            }
        }

        stage('Build and publish image') {
            steps {
                script {
                    @Library('tuleap-jenkinsfile-library@master') _
                    def helpers = load 'sources/tests/helpers.groovy'
                    helpers.authenticateOnTailscale('tailscale-auth-key')
                    def lib_signing = new org.tuleap.Signing();
                    lib_signing.prefetchToolsToSignDockerImages('ci-write');
                    def image_name = 'tuleap-documentation.online-docs';
                    def image = docker.build(
                        image_name,
                        '-f online-docs/Dockerfile .'
                    )
                    def registry_name = "nexus.enalean.com:20000";
                    docker.withRegistry("https://${registry_name}", 'ci-write') {
                        image.push()

                        lib_signing.signDockerImage("${registry_name}/${image_name}", env.VAULT, 'tuleap-additional-tools-signing', 'vault-role-tuleap-additional-tools-signing')
                    }
                }
            }
        }
    }
}
